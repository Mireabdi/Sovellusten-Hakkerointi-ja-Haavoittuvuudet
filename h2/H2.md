# h2 Break & unbreak (Tero)
## ICI012AS3A-3002
## Abdirahman Mire

#### Työympäristö

Käyttöjärjestelmä: Windows 11 Pro 64-bit

CPU: Intel Core i7-12700KF - 4 cores in use

RAM: 6 GB DDR4

Disk: 80gb

Virtuaalikone: VMware, Kali Linux

### X) A01: Broken Access Control – tiivistetysti

- Käyttäjä pääsee toimintoihin tai tietoihin, joihin ei ole oikeutta.

- Yleisiä syitä: puutteelliset backend-tarkistukset, URL/parametrimanipulaatio, vain client-puolen validointi.

  Fuzz with ffuf:

- Web-palvelimilla voi olla piilotettuja hakemistoja.

- ffuf automatisoi URLien fuzzauksen sana-listalla (wordlist).


### A) Murtaudu 010-staff-only

Aloitin komennoilla saadakseni kaiken tarvittavan:

`sudo apt-get update`

`sudo apt-get -y install wget unzip micro`

`wget https://terokarvinen.com/hack-n-fix/teros-challenges.zip`

`unzip teros-challenges.zip`

Seuraavaksi siirryin ja startasin ohjelman:

`cd challenges/010-staff-only/`

`python3 staff-only.py`

![kuva1](/h2/kuvat/kuva1.png)
Sivulla kerrotaan 

`Normally targets don't give you this sql:
SELECT password FROM pins WHERE pin='123'`

Sivulla annettiin vihje muodossa SELECT password FROM pins WHERE pin='123'. Ymmärsin tästä, että PIN-kentän syöte lisätään suoraan SQL-lauseeseen ilman suojausta.

Ensin huomasin että kenttään voi lisätä vain numeroita, joten avasin html inspectorin ja vaihdoin **input type='number'** -> **input type='text'** joka antoi minun laittaa tekstiä vain numero arvon sijaan.

![kuva1](/h2/kuvat/kuva2.png)
![kuva1](/h2/kuvat/kuva3.png)

Käytin paljon aikaa kokeilemalla erilaisia syötteitä PIN-kenttään.

Yksinkertainen injektio **' OR 1=1 --** antoi tunnuksen foo

![kuva1](/h2/kuvat/kuva4.png)

Pitkän pohtimisen jälkeen oivalsin hyödyntää LIMIT-lausetta riveittäin (LIMIT 0,1, LIMIT 1,1, …)

Lopuksi päädyin kokeilemaan lausetta **' OR 1=1 LIMIT 2,1 --** joka antoi superadmin tunnuksen: 

![kuva1](/h2/kuvat/kuva5.png)

### B)  Korjaa 010-staff-only haavoittuvuus lähdekoodista:

kävin läpi lähdekoodia mutta en oikein saanut mitään käsitystä miten korjata haavoittuvaisuus. Yritin seuraa walkthroughta mutta yrittässäni korjata vimillä tuli virhe ilmoitus: 

`IndentationError: unindent does not match any outer indentation level`

### C) FUZZ

Aloitin lataamalla kaiken tarvittavan: 

`wget https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/dirfuzt-0`
`sudo apt-get install ffuf`

käyttöoikeudet:

`chmod u+x dirfuzt-0`

latasin wordlist: 

`wget https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/common.txt`

![kuva1](/h2/kuvat/kuva7.png)
![kuva1](/h2/kuvat/kuva8.png)

Törmäsin ongelmaan: ffuf ei fuzzaa sivuja. Ymmärsin että pitää avata toinen terminaali ja käyttää ffuffia sitä kautta.

`ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 132`

![kuva1](/h2/kuvat/kuva9.png)


sain fuzzattua piilotetut hakemiston: admin.  http://127.0.0.2:8000/admin

`ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 132`

![kuva1](/h2/kuvat/kuva10.png)

![kuva1](/h2/kuvat/kuva11.png)


### D) 020 - Your Eyes Only

Aloitin komennoilla 

`sudo apt-get -y install virtualenv`

Loin virtuaalisen työympäristön:

`cd challenges/020-your-eyes-only/`

`sudo apt-get -y install virtualenv`

`virtualenv virtualenv/ -p python3 --system-site-packages`

Aktivoin työympäristön:

`source virtualenv/bin/activate`

![kuva1](/h2/kuvat/kuva12.png)

Djangon: 

seuraavaksi tarkisin onko Djangon versio vaatimusten mukainen: 

`pip install -r requirements.txt`

`django-admin --version`

![kuva1](/h2/kuvat/kuva13.png)

Django versio on vaatimusten mukainen: 4.2.23

Päivitin tietokannan ja starttasit test serverin: 

`./manage.py makemigrations`

`./manage.py migrate`

`./manage.py runserver`

![kuva1](/h2/kuvat/kuva14.png)

![kuva1](/h2/kuvat/kuva15.png)

tässä en keksinyt mitään järkevää ja lähdin seuraamaan walkthroughta:https://askdatdude.github.io/diary/entries/diary.html?entry=SH24-002&week=

ohjeiden mukaan loin tunnukset ja siirryin adam dashboardiin. sieltä pystyi vaihtamaan URL:stä 127.0.0.1:8000/admin-dashboard -> 127.0.0.1:8000/admin-console


![kuva1](/h2/kuvat/kuva16.png)
![kuva1](/h2/kuvat/kuva17.png)

### 020 Your Eyes Only, korjaus:

Tämä pythonilla korjaus ei oikein suju minulta vielä mutta aion panostaa tähän alueeseen jatkossa. 

#### Referenssit: 

karvinen: https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/

OWASP:https://owasp.org/Top10/A01_2021-Broken_Access_Control/

Karvinen: https://terokarvinen.com/sovellusten-hakkerointi/

robin niinemets: https://askdatdude.github.io/diary/entries/diary.html?entry=SH24-002&week=

PortSwigger: https://portswigger.net/web-security/access-control
